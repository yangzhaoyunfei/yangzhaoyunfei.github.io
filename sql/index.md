# 常用sql


<!--more-->

https://www.jianshu.com/p/5a2dae144238

## mysql 行转列
```sql
select USER_NAME,
       max(case COURSE when '语文' then SCORE else 0 end) "语文",
       max(case COURSE when '数学' then SCORE else 0 end) '数学',
       max(case COURSE when '英语' then SCORE else 0 end) '英语',
       sum(SCORE)                                       '总分',
       avg(SCORE)                                       '平均分'
from student
group by USER_NAME;
```

## mysql 列转行

```sql
select USER_NAME, '语文' course, CN_SCORE score
from grade
union
select USER_NAME, '数学' course, MATH_SCORE score
from grade
union
select USER_NAME, '英语' course, EN_SCORE score
from grade
order by USER_NAME, score
```
-- 1.查询课程编号为‘01’的课程比‘02’的课程成绩高的所有学生的学号、姓名和各自‘01’‘02’课程成绩（多表查询）

思路：通过学生编号将成绩表的课程‘01’成绩和课程‘02’成绩分别取出，join构建一张新表包含：学生编号、课程‘01’成绩、课程‘02成绩’，再将姓名join进来。

-- 2、查询平均成绩大于60分的学生的学号和平均成绩

思路：**以学生学号进行分组**，算平均成绩，筛选输出平均成绩大于60分的学生学号和平均成绩

-- 3、查询所有学生的学号、姓名、选课数、总成绩
思路：**学生表通过学生学号左关联成绩表**，**以学生学号进行分组**，count函数计算选课数，sum函数计算总成绩，ifnull函数将由于左关联产生的成绩表中没有的同学数据null变成0关键函数：GROUP BY、COUNT()、SUM()、IFNULL(  ,  )、LEFT JOIN

-- 4、查询姓“张”的老师的个数

思路：用like筛选老师姓名，**避免姓名重复**通过计算老师id来计算个数

-- 5、查询没学过“张三”老师课的学生的学号、姓名

思路1：从教师表查出“张三”老师的id，从课程表通过t_id查出老师的课程，从成绩表查出有这些课程的学生，从学生表排除这些学生。
思路2：教师表--课程表--成绩表 通过教师编号、课程编号内连接，筛选出有‘张三’的课程成绩的学生编号，在学生表中选出学生编号不在上面选中的学生编号的学生姓名编号和姓名

-- 6、查询学过“张三”老师所教的所有课的同学的学号、姓名

理解1：学过张三老师的课的学生信息

思路:构建一张表包含：学生学号、学生姓名、课程成绩、课程老师。再通过老师姓名筛选

用**分组去重**（虽然本题没有重复结果）
理解2：学了张三老师所有课的学生信息

思路:构建一张表包含：学生学号、学生姓名、课程成绩、课程老师。通过老师姓名筛选。再**按学号分组**，**用统计函数count（课程）选出**学生所选课程数等于张三老师所教的课程数的学生信息


-- 7、查询学过编号为“01”的课程并且也学过编号为“02”的课程的学生的学号、姓名

思路1：通过子查询从成绩表将课程‘01’和课程‘02’的信息分别取出，并内连接得到新表，表中包含选了两门课程的学生id，从学生表中获取学生编号在新表中的学生标号和姓名

思路2：在学生表中选出满足两个条件的学生学号和学生姓名，条件1：有课程编号‘01’成绩的学生编号，条件2：有课程编号‘02’成绩的学生编号

-- 8、查询各门的总成绩、平均成绩和人数

思路：score表的分组统计，以课程分组

-- 9、查询所有课程中成绩小于60分的学生的学号、姓名

思路1：得出成绩表中小于60分的课程数，统计各同学共学了几门课，选出二者相等的学生学号、姓名

-- 9、查询所有课程成绩全都小于60分的学生的学号、姓名

思路，得出各同学课程成绩小于60分的课程数，统计各同学共学了几门课，选出二者相等的学生学号、姓名

-- 10、查询没有学全所有课的学生的学号、姓名

思路：将学生与成绩表通过学生学号左连接，计算每个学生的成绩数，选出小于课程总数的学生学号和姓名


-- 11、查询至少有一门课程与学号为“01”的学生所学课程相同的其他同学的学号

思路：从成绩表表选出‘01’学生学过的课程，从成绩表找出这些上述课程的所有记录，并以学号distinct去重，去掉‘01’同学

-- 12、**查询和“01”号同学所学课程完全相同的其他同学的学号**

思路1：将学号不为‘01’的学生课程编号连接形成新的字段，选出与学号为‘01’的学生课程编号连接形成字段相同的学生学号
关键函数：group_concat、group by
思路2：将学号不为‘01’的学生成绩表以课程号左连接学号为‘01’的学生成绩表，计算每一个学号不为‘01’的学生课程数，选出课程数和‘01’学生相同的学生学号

-- 15、查询两门及其以上不及格课程的同学的学号，姓名及其平均成绩
思路：对成绩表分组统计，符合条件的学号；学生表和成绩表连接后，选择用上述学号过滤，对过滤结果进行分组统计。

-- 16、检索"01"课程分数小于60，按分数降序排列的学生信息
思路：学生表和成绩表通过学生学号链接，用课程编号为‘01’和课程成绩小于60两个条件筛选，最后通过分数降序

-- 17、按平均成绩从高到低显示所有学生的所有课程的成绩以及平均成绩
思路：按照学生学号进行分组排序，用avg计算平均成绩，利用max来显示每一门课的成绩（max函数没有实际意义，只是用来显示），用case when（课程编号为‘01’，输出成绩，否则输出null）得到每一门的课程成绩
注意：这种写法如果一个学生没有选任何一门课，那么他不会出现在结果中。

-- 18、查询各科成绩最高分、最低分和平均分：以如下形式显示：课程ID，课程name，最高分，最低分，平均分，及格率，中等率，优良率，优秀率-- 及格为>=60，中等为：70-80，优良为：80-90，优秀为：>=90 思路：通过课程编号**链接课程表和成绩表**，通过**课程编号分组**，取出课程编号、课程名、最高分、最低分和平均分。**将是否满足条件的分数通过case when函数变成01变量**，求和便是符合条件的学生数，除以参与这一门考试的学生总数，便是各个分数段的概率（妙啊）


-- 20、查询学生的总成绩并进行排名
注意：如果学生没有选课，则不会出现在排名中

-- 21 、查询不同老师所教不同课程平均分从高到低显示

思路：成绩表通过课程编号和课程表进行连接为了获得课程名，再通过老师编号和教师表进行连接为了获得老师名，通过课程编号或者课程名字进行分组，输出课程编号、课程名、教师名、平均分，最后按照平均分排序

-- 22、查询所有课程的成绩第2名到第3名的学生信息及该课程成绩

思路：学生表和成绩表通过课程编号相连接，通过row_number函数增加一列课程成绩在该课程的排名，最后通过子查询筛选出排名，即增加的排名列数字为2，3的数据
分组排序功能：row_number() over(partition by 分组列 order by 排序列 desc)

-- 23、使用分段[100-85],[85-70],[70-60],[<60]来统计各科成绩，分别统计各分数段人数：课程ID和课程名称

思路：通过课程编号将成绩表和课程表连接，再通过课程编号分组，得出课程成绩和课程编号，**通过case when函数将每个分数段的人数转换为0/1或者1/null 形式**，通过sum（0/1）或者count（1/null）得出每个分数段的人数

-- 24、查询学生平均成绩及其名次
思路，如果rank函数不让用，可以用子查询算出平均数，在主查询用rownumber函数加上排名
关键函数：rank

-- 25、查询各科成绩前三名的记录（不考虑成绩并列情况）

思路：学生表和成绩表通过课程编号相连接，**通过row_number函数增加一列课程成绩在该课程的排名，最后通过子查询筛选出排名**，即增加的排名列数字为1,2,3的数据

-- 26、查询每门课程被选修的学生数

-- 27、查询出只有两门课程的全部学生的学号和姓名

思路1：通过学生学号将成绩表和学生表连接，通过学生**学号分组**，计算学生选课成绩的数量，**用having筛选**出数量为2的信息，输出学生学号和姓名

思路2：成绩表通过学生学号分组，选出选课成绩为2的学生学号；通过子查询，在学生表中去的学生学号和姓名

-- 28、查询男生、女生人数

思路1：通过性别进行分组，计算每个性别人数

-- 29 查询名字中含有"风"字的学生信息

思路：用like进行字符串匹配

-- 31、查询1990年出生的学生名单
思路1：用like进行字符串匹配的方法得到出生日期为1990年

看 哈工大数据库课程，找三种基本sql类型
